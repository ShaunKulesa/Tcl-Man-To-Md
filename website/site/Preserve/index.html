<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://www.tcl.tk/man/tcl8.6.13/TclCmd/contents.html/Preserve/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>NAME - Tcl/Tk</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "NAME";
        var mkdocs_page_input_path = "Preserve.md";
        var mkdocs_page_url = "/man/tcl8.6.13/TclCmd/contents.html/Preserve/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Tcl/Tk
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../command.md">Commands</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Tcl/Tk</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>NAME</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="name">NAME</h1>
<p>Tcl_Preserve, Tcl_Release, Tcl_EventuallyFree - avoid freeing storage
while it is being used</p>
<h1 id="synopsis">SYNOPSIS</h1>
<pre><code>#include &lt;tcl.h&gt;

Tcl_Preserve(clientData)

Tcl_Release(clientData)

Tcl_EventuallyFree(clientData, freeProc)
</code></pre>
<h1 id="arguments">ARGUMENTS</h1>
<p>Token describing structure to be freed or reallocated. Usually a pointer
to memory for structure.</p>
<p>Procedure to invoke to free <em>clientData</em>.</p>
<h1 id="description">DESCRIPTION</h1>
<p>These three procedures help implement a simple reference count mechanism
for managing storage. They are designed to solve a problem having to do
with widget deletion, but are also useful in many other situations. When
a widget is deleted, its widget record (the structure holding
information specific to the widget) must be returned to the storage
allocator. However, it is possible that the widget record is in active
use by one of the procedures on the stack at the time of the deletion.
This can happen, for example, if the command associated with a button
widget causes the button to be destroyed: an X event causes an
event-handling C procedure in the button to be invoked, which in turn
causes the button\'s associated Tcl command to be executed, which in
turn causes the button to be deleted, which in turn causes the button\'s
widget record to be de-allocated. Unfortunately, when the Tcl command
returns, the button\'s event-handling procedure will need to reference
the button\'s widget record. Because of this, the widget record must not
be freed as part of the deletion, but must be retained until the
event-handling procedure has finished with it. In other situations where
the widget is deleted, it may be possible to free the widget record
immediately.</p>
<p><strong>Tcl_Preserve</strong> and <strong>Tcl_Release</strong> implement short-term reference
counts for their <em>clientData</em> argument. The <em>clientData</em> argument
identifies an object and usually consists of the address of a structure.
The reference counts guarantee that an object will not be freed until
each call to <strong>Tcl_Preserve</strong> for the object has been matched by calls
to <strong>Tcl_Release</strong>. There may be any number of unmatched
<strong>Tcl_Preserve</strong> calls in effect at once.</p>
<p><strong>Tcl_EventuallyFree</strong> is invoked to free up its <em>clientData</em> argument.
It checks to see if there are unmatched <strong>Tcl_Preserve</strong> calls for the
object. If not, then <strong>Tcl_EventuallyFree</strong> calls <em>freeProc</em>
immediately. Otherwise <strong>Tcl_EventuallyFree</strong> records the fact that
<em>clientData</em> needs eventually to be freed. When all calls to
<strong>Tcl_Preserve</strong> have been matched with calls to <strong>Tcl_Release</strong> then
<em>freeProc</em> will be called by <strong>Tcl_Release</strong> to do the cleanup.</p>
<p>All the work of freeing the object is carried out by <em>freeProc</em>.
<em>FreeProc</em> must have arguments and result that match the type
<strong>Tcl_FreeProc</strong>:</p>
<p>typedef void <strong>Tcl_FreeProc</strong>( char *<em>blockPtr</em>);</p>
<p>The <em>blockPtr</em> argument to <em>freeProc</em> will be the same as the
<em>clientData</em> argument to <strong>Tcl_EventuallyFree</strong>. The type of <em>blockPtr</em>
(<strong>char *</strong>) is different than the type of the <em>clientData</em> argument to
<strong>Tcl_EventuallyFree</strong> for historical reasons, but the value is the
same.</p>
<p>When the <em>clientData</em> argument to <strong>Tcl_EventuallyFree</strong> refers to
storage allocated and returned by a prior call to <strong>Tcl_Alloc</strong> or
another function of the Tcl library, then the <em>freeProc</em> argument should
be given the special value of <strong>TCL_DYNAMIC</strong>.</p>
<p>This mechanism can be used to solve the problem described above by
placing <strong>Tcl_Preserve</strong> and <strong>Tcl_Release</strong> calls around actions that
may cause undesired storage re-allocation. The mechanism is intended
only for short-term use (i.e. while procedures are pending on the
stack); it will not work efficiently as a mechanism for long-term
reference counts. The implementation does not depend in any way on the
internal structure of the objects being freed; it keeps the reference
counts in a separate structure.</p>
<h1 id="see-also">SEE ALSO</h1>
<p>Tcl_Interp, Tcl_Alloc</p>
<h1 id="keywords">KEYWORDS</h1>
<p>free, reference count, storage</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
